<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phoenix Command | Google Ads Sync</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0a0a0b;
      --bg-card: #111113;
      --bg-elevated: #18181b;
      --border: #27272a;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --phoenix-orange: #f97316;
      --phoenix-amber: #f59e0b;
      --phoenix-green: #22c55e;
      --phoenix-red: #ef4444;
      --phoenix-blue: #3b82f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--phoenix-orange), var(--phoenix-amber));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
    }

    .stat-value.green { color: var(--phoenix-green); }
    .stat-value.orange { color: var(--phoenix-orange); }
    .stat-value.blue { color: var(--phoenix-blue); }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title { font-size: 1rem; font-weight: 600; }

    .controls { display: flex; gap: 0.75rem; align-items: center; }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--phoenix-orange);
      color: white;
    }

    .btn-primary:hover { background: #ea580c; }

    .btn-green {
      background: var(--phoenix-green);
      color: white;
    }

    .btn-green:hover { background: #16a34a; }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover { background: var(--border); }

    .table-wrapper { overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; }

    th, td {
      padding: 0.875rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    td { font-size: 0.875rem; }
    tr:hover { background: rgba(255, 255, 255, 0.02); }

    .tier-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .tier-very_good { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .tier-good { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .tier-fair { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
    .tier-poor { background: rgba(161, 161, 170, 0.2); color: #a1a1aa; }
    .tier-very_poor { background: rgba(239, 68, 68, 0.2); color: #f87171; }

    .phone { font-family: monospace; color: var(--text-secondary); }
    .gclid { font-family: monospace; font-size: 0.75rem; color: var(--text-muted); max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .loading { text-align: center; padding: 3rem; color: var(--text-muted); }

    .filter-row {
      padding: 1rem 1.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
    }

    .filter-select {
      padding: 0.5rem 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .instructions {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .instructions h3 {
      color: var(--phoenix-orange);
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }

    .instructions ol {
      padding-left: 1.25rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.8;
    }

    .instructions strong { color: var(--text-primary); }

    .value-col { color: var(--phoenix-green); font-weight: 600; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <div class="logo-icon">ðŸ”¥</div>
      <span>Phoenix Command</span>
      <span style="color: var(--text-muted); font-weight: 400;">/ Google Ads Sync</span>
    </div>
    <div class="controls">
      <button class="btn btn-secondary" onclick="loadData()">â†» Refresh</button>
      <a id="csv-link" class="btn btn-green" href="#" target="_blank">â¬‡ Download CSV</a>
    </div>
  </div>

  <div class="container">
    <div class="instructions">
      <h3>ðŸ“‹ How to Upload to Google Ads</h3>
      <ol>
        <li>Click <strong>"Download CSV"</strong> above</li>
        <li>Go to <strong>Google Ads â†’ Goals â†’ Conversions â†’ Uploads</strong></li>
        <li>Click <strong>"+"</strong> â†’ Upload your CSV file</li>
        <li>Review matches and click <strong>"Apply"</strong></li>
      </ol>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">Calls with GCLID</div>
        <div class="stat-value orange" id="stat-gclid">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">With Value</div>
        <div class="stat-value green" id="stat-valued">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Value</div>
        <div class="stat-value blue" id="stat-value">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Unique Callers</div>
        <div class="stat-value" id="stat-callers">-</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">ðŸ“ž CallRail Calls with GCLID</div>
      </div>

      <div class="filter-row">
        <select class="filter-select" id="filter-tier" onchange="renderTable()">
          <option value="">All Tiers</option>
          <option value="very_good">Converted (100%)</option>
          <option value="good">Hot Lead (75%)</option>
          <option value="fair">Good Lead (50%)</option>
          <option value="poor">OK Lead (25%)</option>
          <option value="very_poor">Not Good ($0)</option>
        </select>
        <select class="filter-select" id="filter-days" onchange="loadData()">
          <option value="1">Last 24 hours</option>
          <option value="7" selected>Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Phone</th>
              <th>Campaign</th>
              <th>Lead Score</th>
              <th>Product</th>
              <th>Value</th>
              <th>Duration</th>
              <th>GCLID</th>
            </tr>
          </thead>
          <tbody id="data-table">
            <tr><td colspan="8" class="loading">Click Refresh to load data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API = '/.netlify/functions/sync-gads-conversions';
    let allConversions = [];

    async function loadData() {
      const days = document.getElementById('filter-days').value;
      const hours = days * 24;
      const tbody = document.getElementById('data-table');
      tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';

      // Update CSV download link
      document.getElementById('csv-link').href = `${API}?hours=${hours}&format=csv`;

      try {
        const res = await fetch(`${API}?hours=${hours}`);
        const data = await res.json();

        if (data.success) {
          allConversions = data.conversions || [];
          document.getElementById('stat-gclid').textContent = data.stats.withGclid || 0;
          document.getElementById('stat-valued').textContent = data.stats.withValue || 0;
          document.getElementById('stat-value').textContent = data.stats.totalValue || '$0';
          document.getElementById('stat-callers').textContent = data.stats.uniqueCallers || 0;
          renderTable();
        } else {
          tbody.innerHTML = `<tr><td colspan="8" class="loading" style="color: var(--phoenix-red);">Error: ${data.error}</td></tr>`;
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" class="loading" style="color: var(--phoenix-red);">Failed: ${err.message}</td></tr>`;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('data-table');
      const tierFilter = document.getElementById('filter-tier').value;

      const filtered = allConversions.filter(c => {
        if (tierFilter && c.tier !== tierFilter) return false;
        return true;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="loading">No conversions found</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(c => `
        <tr>
          <td>${c.conversionTime || '-'}</td>
          <td class="phone">${c.phone || '-'}</td>
          <td>${c.campaign || 'Direct'}</td>
          <td><span class="tier-badge tier-${c.tier}">${formatTier(c.tier)}</span></td>
          <td>${c.product}</td>
          <td class="value-col">${c.value}</td>
          <td>${c.duration}</td>
          <td class="gclid" title="${c.gclid}">${c.gclid}</td>
        </tr>
      `).join('');
    }

    function formatTier(tier) {
      const labels = {
        'very_good': 'Converted (100%)',
        'good': 'Hot (75%)',
        'fair': 'Good (50%)',
        'poor': 'OK (25%)',
        'very_poor': 'Not Good ($0)'
      };
      return labels[tier] || tier;
    }

    // Auto-load on page open
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
